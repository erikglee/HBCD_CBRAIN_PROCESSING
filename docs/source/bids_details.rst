.. HBCD_CBRAIN_PROCESSING documentation master file, created by
   sphinx-quickstart on Wed Jun  5 10:48:12 2024.
   You can adapt this file completely to your liking, but it should at least
   contain the root `toctree` directive.

Relevant BIDS Details for HBCD Processing
-----------------------------------------

As much as possible, HBCD processing tries to utilize the `Brain
Imaging Data Structure  <https://bids-specification.readthedocs.io/en/stable/>`_
(BIDS) standard for data organization. Because of this, the applications
used to process HBCD data are also designed to be `BIDS-Apps <https://bids-apps.neuroimaging.io/>`_.

In this section, we describe some of the key elements of HBCD BIDS organization
as it pertains to processing. At a high level, the HBCD BIDS structure will appear
as follows: ::

    assembly_bids/
    ├── participants.tsv
    ├── participants.json
    ├── sub-<label>/
    │   ├── sub-<label>_sessions.tsv
    │   ├── sub-<label>_sessions.json
    │   ├── ses-<label>/
    │   │   ├── anat/
    │   │   ├── dwi/
    │   │   ├── eeg/
    │   │   ├── fmap/
    │   │   ├── func/
    │   │   ├── motion/
    │   │   ├── mrs/
    │   │   ├── sub-<label>_ses-<label>_scans.tsv
    │   │   ├── sub-<label>_ses-<label>_scans.json

First, as expected with a large infant study, many
subjects will have missing data elements. Because of this,
there will be a different number of folders and files available
for unique subjects and sessions. Second, due to the multimodal
nature of the HBCD acquisition, some of the modalities are collected
at different times, and even within modality there may be certain
acquisitions that are collected on different days.

The complexity of the data acquisition and the varying image quality
across acquisitions makes the scans.tsv file (found under the session
folder) a critical component of the BIDS structure. This file contains
information about when an acquisiton was collected, how old the participant
was at the time of the acquisition, and other relevant information such as
quality controls.

The scans.tsv serves as the best source of information about the age of a
participant at the time of an acquisition. Age information can also be found
in the sessions.tsv file under the session folder, where "age" represents the
age of the participant at the first in-person data collection. All "age" measures
are provided in years with three decimal places, based on a birthdate measure
that is jittered up to 7 days.

In the structure above, data from a given session folder is not
necessarily collected at the same timepoint. This is even  certain subjects will be missing
a subset of these folders will be curated in the BIDS structure, unless miDue to the multimodal nature of the HBCD study and
also the challenges of collecting quality data on infants,
all the data collected in a single session is 



`BIBSNET <https://www.ncbi.nlm.nih.gov/pmc/articles/PMC10055337/>`_

BIDS standard
data organization, and have processing routines that are designed
as BIDS-Apps.

The BIDS directory should have exactly one T1w and/or T2w image
for each session that will be processed. The T1w and/or T2w image
should already be registered to the segmentation(s) found in the
segmentations directory. If both T1w/T2w images and segmentations
are present, the pipeline will currently (as of 6/5/24) give priority
to registering the relaxometry images to the T2w images in the BIDS directory
by default.

qMRI/relaxometry directory
---------------------------

The quantitative MRI directory should contain derived relaxometry maps, along
with a synthetic T1w and T2w image. At minimum, there should be at least one
T1map, T2map, or PDmap in a subject (or session) quantitative MRI directory. It is assumed that there is
at most one of each image type, and also that all images were derived from the same
acquisition. Following this assumption, all images within this directory should be
registered to one another. The expected names of the files (with \"\*\"
denoting wildcard, and [] denoting optional elements of file path/names) are as follows: ::

   /qmri_dir/sub-<label>[/ses-<label>]/anat/sub-<label>[_ses-<label>]*T1map.nii.gz
   /qmri_dir/sub-<label>[/ses-<label>]/anat/sub-<label>[_ses-<label>]_ses-<label>*T2map.nii.gz
   /qmri_dir/sub-<label>[/ses-<label>]/anat/sub-<label>[_ses-<label>]_ses-<label>*PDmap.nii.gz
   /qmri_dir/sub-<label>[/ses-<label>]/anat/sub-<label>[_ses-<label>]_ses-<label>*T1w.nii.gz
   /qmri_dir/sub-<label>[/ses-<label>]/anat/sub-<label>[_ses-<label>]_ses-<label>*T2w.nii.gz

There may be additional files in the directory that are not used by the pipeline, as
long as they don't match the file patterns mentioned in this section. In HBCD these files are 
currently generated by SyMRI's relaxometry tool, but any tool can be used to generate these files.
In all cases the images must have corresponding json files, which can be empty if there is no
associated metadata.

Beyond the expectation that all images in a given session folder are registered to one another,
it is also assumed that all images have the same dimensions and voxel resolutions. 

BIBSNET Directory (i.e. segmentation directory)
-----------------------------------------------

The segmentations found under this directory should be of the
following form: ::
   
   /segmentation_dir/sub-<label>[/ses-<label>]/anat/sub-<label>[_ses-<label>]*space-<label>_desc-aseg_dseg.nii.gz
   /segmentation_dir/sub-<label>[/ses-<label>]/anat/sub-<label>[_ses-<label>]*space-<label>_desc-brain_mask.nii.gz
   
In the above formatting, the presence of a session folder is optional. The "*" icon denotes
flexibility in the naming convention at a certain point, and the final label entry following "space-"
must either be T1w or T2w. The first file described above is a segmentation with individual brain
regions, and the second file is a binary brain mask that is used to aid in the registration.

In HBCD both of these files are generated by `BIBSNET <https://www.ncbi.nlm.nih.gov/pmc/articles/PMC10055337/>`_, but any segmentations using the naming
convention above with voxel values that correspond to the `FreeSurferColorLUT file <https://surfer.nmr.mgh.harvard.edu/fswiki/FsTutorial/AnatomicalROI/FreeSurferColorLUT>`_ can be used.
No matter what tool is used to generate the segmentations, the FreeSurferColorLUT will first be
loaded, then the segmentation will be loaded, and following a registration procedure any non-zero
value within the segmentation will be mapped to the corresponding label in the FreeSurferColorLUT.
If there is a voxel label that is not found in the FreeSurferColorLUT this will result in an error.

region_groupings_json
---------------------

This file is a json whose keys correspond to user-specified custom names for one
or more groupings of brain regions, and whose values are lists of the brain region
labels that are to be included in each grouping. The labels included in the list
must come directly from the "Label Name" column of the `FreeSurferColorLUT file <https://surfer.nmr.mgh.harvard.edu/fswiki/FsTutorial/AnatomicalROI/FreeSurferColorLUT>`_. When
the tool is given a region_groupings_json, relaxometry statistics will be computed
within all voxels that correspond to a given group.

An example formatting is as follows: ::

   {
       "Cerebral-Cortex": ["Left-Cerebral-White-Matter", "Right-Cerebral-White-Matter"],
       "Cerebral-White-Matter": ["Left-Cerebral-Cortex", "Right-Cerebral-Cortex"]
   }

If there exists a given region grouping where no voxels are found within a segmentation
image, the given grouping will have statistics with NaN values.


.. toctree::
   :maxdepth: 2
   :caption: Contents: